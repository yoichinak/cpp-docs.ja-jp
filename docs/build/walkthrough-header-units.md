---
description: ヘッダー ファイルをヘッダー ユニットに変換することによる C++ ヘッダー ユニットの詳細について説明します
title: 'チュートリアル: Microsoft Visual C++ プロジェクトでヘッダー ユニットをビルドしてインポートする'
ms.date: 4/13/2021
ms.custom: conceptual
author: tylermsft
ms.author: twhitney
helpviewer_keywords:
- import
- header unit
- ifc
ms.openlocfilehash: cb2f9b8470dfdc01831f0b73b32e27d0ff392b13
ms.sourcegitcommit: bac5dde649d5b0447de1d26a73365e36d74595f3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/13/2021
ms.locfileid: "107381424"
---
# <a name="walkthrough-build-and-import-header-units-in-microsoft-visual-c"></a>チュートリアル: Microsoft Visual C++ でヘッダー ユニットをビルドしてインポートする

この記事では、Visual Studio 2019 を使用したヘッダー ユニットのビルドとインポートについて説明します。 ヘッダー ユニットとして標準テンプレート ライブラリ ヘッダーをインポートする方法については、「[STL ライブラリをヘッダ ーユニットとしてインポートする](walkthrough-import-stl-header-units.md)」を参照してください。

ヘッダー ユニットは、[プリコンパイル済みヘッダー ファイル](creating-precompiled-header-files.md) (PCH) の代替手段として推奨されます。 [共有 PCH](https://devblogs.microsoft.com/cppblog/shared-pch-usage-sample-in-visual-studio) と比べてより簡単にセットアップして使用することができ、同様のパフォーマンス上の利点が得られます。 PCH とは異なり、ヘッダー ユニットを変更したときにリビルドされるのは、それ自体とその依存関係だけです。

## <a name="prerequisites"></a>前提条件

ヘッダー ユニットをサポートするには、少なくとも Visual Studio 2019 16.10.0 Preview 2 が必要です。

## <a name="what-is-a-header-unit"></a>ヘッダー ユニットとは

ヘッダー ユニットは、ヘッダー ファイルのバイナリ表現であり、末尾の拡張子は *`.ifc`* です。 これは、名前付きモジュールに使用される形式でもあります。

ヘッダー ユニットとヘッダー ファイルの重要な違いは、ヘッダー ユニットはマクロ定義の影響を受けないことです。 ヘッダー ファイルでは `#define` を使用してシンボルを定義し、インポート時の動作を変えることができますが、ヘッダー ユニットではそのようなことはできません。

類似点としては、ヘッダー ファイルから参照できるものはすべて、ヘッダー ユニットからも参照できます。

ヘッダー ユニットをインポートする前に、ヘッダー ファイルをヘッダー ユニットにコンパイルする必要があります。 PCH よりヘッダー ユニットの方が優れているのは、分散ビルドで使用できることです。 たとえば、 *`.ifc`* とそれをインポートするプログラムを、同じコンパイラを使用してコンパイルし、それらで同じプラットフォームとアーキテクチャを対象としている場合は、あるコンピューターで生成されたヘッダー ユニットを別のコンピューターで使用できます。

PCH に対するヘッダー ユニットのもう 1 つの利点は、ヘッダー ユニットとそれをインポートするプログラムのコンパイルに使用されるコンパイラ フラグに関して、より高い柔軟性を備えていることです。 PCH では、より多くのコンパイラ フラグが同じである必要があります。 しかし、ヘッダー ユニットを使用すると、同じである必要のある主要なフラグは次のようになります。

- `/EHsc` などの例外処理スイッチ
- `/MD[d]` または `MT[d]`
- `/D` ヘッダー ユニットをインポートするプログラムをビルドするときに追加のマクロを定義できますが、ヘッダー ユニットをインポートするプログラムをビルドするときに、ヘッダー ユニットのビルドに使用されるものも存在し、同じ方法で定義されている必要があります。

## <a name="ways-to-compile-a-header-unit"></a>ヘッダー ユニットをコンパイルする方法

ファイルをヘッダー ユニットにコンパイルするには、いくつかの方法があります。

- **ヘッダー ユニットを自動的にスキャンする**: この方法は、多くの異なるヘッダー ファイルが含まれる小さなプロジェクトに最適です。 この方法のデモについては、「[チュートリアル: STL ライブラリをヘッダ ーユニットとしてインポートする](walkthrough-import-stl-header-units.md#approach1)」を参照してください。 小さなプロジェクトに適している理由は、すべてのファイルをスキャンしてヘッダー ユニットに組み込む必要があるものを見つけるため、最適なビルド スループットを保証できないためです。

- **共有ヘッダー ユニット プロジェクトを作成する**: この方法は、大規模なプロジェクトの場合、およびインポートされたヘッダー ユニットの編成をより詳細に制御する必要がある場合に最適です。 必要なヘッダー ユニットが含まれるスタティック ライブラリ プロジェクト (1 つまたは複数) を作成します。 次に、プロジェクトからライブラリ プロジェクト (1 つまたは複数) を参照し、必要なヘッダー ユニットをインポートします。 この方法のデモについては、「[チュートリアル: STL ライブラリをヘッダ ーユニットとしてインポートする](walkthrough-import-stl-header-units.md#approach2)」を参照してください。

- **ビルドするヘッダー ユニットを個別に選択する**: この方法を使用すると、ヘッダー ユニットとして処理されるヘッダー ファイルを、ファイルごとに制御できます。 また、プロジェクトでヘッダー ユニットをすばやく選択して試すこともできます。 この方法についてはこのチュートリアルで示します。

## <a name="convert-a-project-to-use-header-units"></a>ヘッダー ユニットを使用するようにプロジェクトを変換する

この例では、ヘッダー ファイルをヘッダー ユニットとしてコンパイルします。 最初に、Visual Studio で次のプロジェクトを作成します。

1. 新しい C++ コンソール アプリ プロジェクトを作成します。
1. ソース ファイルの内容を次のように置き換えます。
    ```cpp
    #include "Pythagorean.h"
    
    int main()
    {
        PrintPythogoreanTriple(2,3);
        return 0;
    }
    ```
1. `Pythagorean.h` という名前のヘッダー ファイルを追加し、その内容を次のように置き換えます。
    ```cpp
    #pragma once
    #include <iostream>
    
    void PrintPythogoreanTriple(int a, int b)
    {
        std::cout << "Pythagorean triple a:" << a << " b:" << b << " c:" << a*a + b*b << std::endl;
    }
    ```

ヘッダー ユニットを有効にするには、最初に **C++ 言語標準** を [`/std:c++latest`](./reference/std-specify-language-standard-version.md) に設定します。

1. Visual Studio のメイン メニューから、 **[プロジェクト]**  >  **[プロパティ]** を選択します。
1. プロジェクトのプロパティ ページ ウィンドウの左側のペインで、 **[構成プロパティ]**  >  **[全般]** を選択します。
1. **[C++ 言語標準]** ドロップダウンを **[プレビュー - 最新の C++ Working Draft からの機能 (/std:c++latest)]** に変更します。
:::image type="content" source="media/set-cpp-language-latest.png" alt-text="言語標準をプレビュー バージョンに設定するスクリーンショット。":::

### <a name="compile-a-header-file-as-a-header-unit"></a>ヘッダー ファイルをヘッダー ユニットとしてコンパイルする

**ソリューション エクスプローラー** で、ヘッダー ユニットとしてコンパイルするファイルを選択します。 そのファイルを右クリックし、 **[プロパティ]** を選択します。 ファイルの種類に応じて、次のいずれかの操作を行います。

**ヘッダー ファイルの場合**:

**[項目の種類]** プロパティを **[C/C++ コンパイラ]** に設定します。 既定では、ヘッダー ファイルの **[項目の種類]** は **[C/C++ ヘッダー]** です。 このプロパティを設定すると、 **[C/C++]**  >  **[詳細]**  >  **[コンパイル言語の選択]** も **[C++ ヘッダー ユニットとしてコンパイルする (/exportHeader)]** に自動的に設定されます。
:::image type="content" source="media/change-item-type.png" alt-text="C/C++ コンパイラへの項目の種類の変更を示すスクリーンショット。":::

**ソース ファイルの場合** (または、拡張子が `.h` または `.hpp` ではないヘッダー ファイル):

**[コンパイル言語の選択]** を **[C++ ヘッダー ユニットとしてコンパイルする (/exportHeader)]** に設定します。
:::image type="content" source="media/change-compile-as.png" alt-text="[コンパイル言語の選択] の [C++ ヘッダー ユニットとしてコンパイルする] への変更を示すスクリーンショット。":::

### <a name="change-your-code-to-import-a-header-unit"></a>ヘッダー ユニットをインポートするようにコードを変更する

サンプル プロジェクトのソース ファイル、つまり `main()` が含まれるファイルで、`#include "Pythagorean.h"` を `import "Pythagorean.h";` に変更します (`import` ステートメントに必要な末尾のセミコロンを忘れないでください)。 システム ヘッダーからヘッダー ユニットをコンパイルするときは、山かっこ (`import <file>;`) を使用します。 プロジェクト ヘッダーの場合は、`import "file";` を使用します

ソリューションをビルドして (メイン メニューから **[ビルド]**  >  **[ソリューションのビルド]** )、実行して、予想される出力 `Pythagorean triple a:2 b:3 c:13` が生成されることを確認します。

独自のプロジェクトで、このプロセスを繰り返して、ヘッダー ユニットとしてインポートするヘッダー ファイルをコンパイルします。

いくつかのヘッダー ファイルをヘッダー ユニットに変換するだけの場合は、この方法を使用することをお勧めします。 ただし、コンパイルするヘッダー ファイルが多数あり、ビルド システムで自動的に処理する利便性の方が、ビルドのパフォーマンスに与える影響より大きい場合は、ビルド システムで自動的にヘッダー ユニットをスキャンしてビルドできます。 方法については、「[チュートリアル: STL ライブラリをヘッダ ーユニットとしてインポートする](walkthrough-import-stl-header-units.md#approach1)」を参照してください。

## <a name="see-also"></a>関連項目

[チュートリアル: STL ライブラリをヘッダ ーユニットとしてインポートする](walkthrough-import-stl-header-units.md#approach1)\
[C++ のモジュールの概要](../cpp/modules-cpp.md) \
[`/translateInclude`](./reference/translateinclude.md) \
[`/exportHeader`](./reference/module-exportheader.md) \
[`/headerUnit`](./reference/headerunit.md)